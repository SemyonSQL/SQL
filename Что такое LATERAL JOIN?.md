#### LATER JOIN как альтернатива оконной функции.

Дана схема представленная ниже, задача написать запрос который возвращает 2 поста с наибольшим количеством просмотров для каждой категории.

Примечание:
В некоторых категориях может быть менее двух сообщений или вообще не быть сообщений.
Два или более поста в категории могут иметь одинаковое количество просмотров. 
Используйте идентификатор поста для определения приоритета — пост с более низким идентификатором получает более высокий рейтинг.

categories:
 Column     | Type                        | Modifiers
|-----------|:---------------------------:|--------:|
id          | integer                     | not null
category    | character varying(255)      | not null

posts:
 Column     | Type                        | Modifiers
------------|:---------------------------:|--------:|
id          | integer                     | not null
category_id | integer                     | not null
title       | character varying(255)      | not null
views       | integer                     | not null


Решение:
```SQL
SELECT c.id as category_id, c.category, foo.title, foo.views, foo.id as post_id
FROM categories c
LEFT JOIN LATERAL (SELECT *
        FROM posts p
        WHERE p.category_id = c.id 
        ORDER BY views DESC, p.id
        LIMIT 2) as foo ON true
ORDER BY c.category, foo.views DESC, foo.id
```

В чем же тут загадка? 
  


Сам по себе подзапрос выдаст очевидно только 2 строчки из-за ```LIMIT 2```
<details><summary><b><u> поздапрос </u></b></summary>
<p>

```SQL
SELECT *
FROM posts p
--WHERE p.category_id = c.id 
ORDER BY views DESC, p.id
LIMIT 2
``` 
</p>
</details>

Волшебство заключается в том, что вы можете ссылаться на исходную таблицу в правой части подзапроса LATERAL. 
Тот же результат, что и для ранжирования с помощью оконной функцией. 

Если решать задачу с помощью оконной функции, нам потребовалось бы 
1) Создать запрос с оконной функцией с рангами внутри каждой категории. 
```ROW_NUMBER() OVER (ORDER BY views,id PARTITION BY category_id)```
2) Подзапросом отфильтровать таблицу 
3) Сджойнить таблицы по id категорий.

LATERAL JOIN позволяет решить эту задачу в 2 этапа. 

Перевод официальной документации:
Ключевое слово LATERAL может предшествовать подзапросу. 
Это позволяет подзапросу ссылаться на столбцы элементов основного запроса.
(Без LATERAL каждый вложенный SELECT оценивается независимо и поэтому не может ссылаться на какой-либо другой элемент FROM.)

Принцип работы:
Для каждой строки или набора строк из исходной таблицы выполняется LATERAL подзапрос и джойнится как обычно (но только с теми строками, из которых он вычислялся).

В нашем случае, подзапрос возвращает по 2 строки для каждой категории из таблицы categories.

